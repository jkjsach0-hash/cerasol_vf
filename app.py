import streamlit as st
import pandas as pd
from datetime import datetime, date

# -----------------------------------------------------------------------------
# 1. í˜ì´ì§€ ì„¤ì • ë° ì œëª©
# -----------------------------------------------------------------------------
st.set_page_config(page_title="ì†Œì„± ë¹„ìš© ê³„ì‚°ê¸°", layout="wide")

st.title("ğŸ­ ì„¤ë¹„ ê´€ë¦¬ ë° ë¹„ìš© ì‚°ì¶œ")
st.markdown("ì„¤ë¹„ë³„ ê°ê°€ìƒê° í˜„í™©ê³¼ ì¬êµ¬ì…ì„ ìœ„í•œ ì ë¦½ ë¹„ìš©ì„ í™•ì¸í•©ë‹ˆë‹¤.")

# -----------------------------------------------------------------------------
# 2. ë°ì´í„° ë¡œë“œ (ë‚˜ì¤‘ì—ëŠ” êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ê°€ì ¸ì˜¤ëŠ” ë¶€ë¶„ìœ¼ë¡œ ëŒ€ì²´ë©ë‹ˆë‹¤)
# -----------------------------------------------------------------------------
# ê°€ìƒì˜ êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„°
data = {
    'ì„¤ë¹„ëª…': ['ì „ê¸°ê°€ë§ˆ 0.3ë£¨ë² ', 'ì „ê¸°ë¬¼ë ˆ A', 'í† ë ¨ê¸°'],
    'ì·¨ë“ì›ê°€': [5000000, 800000, 2500000],
    'êµ¬ì…ì¼ì': ['2021-01-15', '2022-03-10', '2020-06-20'],
    'ë‚´ìš©ì—°ìˆ˜': [10, 5, 8]  # ë‹¨ìœ„: ë…„
}
df = pd.DataFrame(data)

# ë‚ ì§œ í˜•ì‹ ë³€í™˜
df['êµ¬ì…ì¼ì'] = pd.to_datetime(df['êµ¬ì…ì¼ì'])

# -----------------------------------------------------------------------------
# 3. í•µì‹¬ ê³„ì‚° ë¡œì§
# -----------------------------------------------------------------------------
today = datetime.now()
end_of_year = datetime(today.year, 12, 31)

def calculate_metrics(row):
    cost = row['ì·¨ë“ì›ê°€']
    life_years = row['ë‚´ìš©ì—°ìˆ˜']
    buy_date = row['êµ¬ì…ì¼ì']
    
    # 1. ì—°ê°„ ê°ê°€ìƒê°ë¹„ (1ë…„ì¹˜ ë§ˆëª¨ ë¹„ìš©)
    depreciation_per_year = cost / life_years
    
    # 2. ê²½ê³¼ ì¼ìˆ˜ ë° ì—°ìˆ˜ ê³„ì‚°
    days_passed = (today - buy_date).days
    years_passed = days_passed / 365.0
    
    # 3. í˜„ì¬ ê°ê°€ìƒê° ì”ì•¡ (í˜„ì¬ ê°€ì¹˜)
    # (ì·¨ë“ì›ê°€ - (ì—°ê°„ìƒê°ë¹„ * ê²½ê³¼ì—°ìˆ˜)), ë‹¨ 0ì› ë¯¸ë§Œìœ¼ë¡œ ë‚´ë ¤ê°€ì§€ ì•ŠìŒ
    current_book_value = max(cost - (depreciation_per_year * years_passed), 0)
    
    # 4. ì˜¬í•´ ë§ ê¸°ì¤€ ì˜ˆìƒ ì”ê°€
    days_until_eoy = (end_of_year - buy_date).days
    years_until_eoy = days_until_eoy / 365.0
    eoy_book_value = max(cost - (depreciation_per_year * years_until_eoy), 0)
    
    # 5. ì¬êµ¬ì… ì ë¦½ í•„ìš” ë¹„ìš© (ì˜¬í•´ í• ë‹¹ë¶„)
    # ë‹¨ìˆœíˆ ìƒê°í•˜ë©´ 'ì—°ê°„ ê°ê°€ìƒê°ë¹„'ê°€ ê³§ ë§¤ë…„ ì ë¦½í•´ì•¼ í•  ë¹„ìš©ì…ë‹ˆë‹¤.
    replacement_fund_yearly = depreciation_per_year

    return pd.Series([current_book_value, eoy_book_value, replacement_fund_yearly])

# ë°ì´í„°í”„ë ˆì„ì— ê³„ì‚° ê²°ê³¼ ì ìš©
df[['í˜„ì¬ì”ì•¡', 'ì˜¬í•´ë§ì”ê°€', 'ì—°ê°„ì ë¦½í•„ìš”ì•¡']] = df.apply(calculate_metrics, axis=1)

# -----------------------------------------------------------------------------
# 4. í™”ë©´ UI êµ¬ì„±
# -----------------------------------------------------------------------------

# [ì„¹ì…˜ 1] ìš”ì•½ ì§€í‘œ (KPI)
st.subheader("ğŸ“Š ì „ì²´ ì„¤ë¹„ ìš”ì•½")
col1, col2, col3 = st.columns(3)

total_acquisition = df['ì·¨ë“ì›ê°€'].sum()
total_current_value = df['í˜„ì¬ì”ì•¡'].sum()
total_yearly_fund = df['ì—°ê°„ì ë¦½í•„ìš”ì•¡'].sum()

with col1:
    st.metric(label="ì´ ì·¨ë“ ì›ê°€", value=f"{total_acquisition:,.0f} ì›")
with col2:
    st.metric(label="í˜„ì¬ ì„¤ë¹„ ì´ ì”ì•¡", value=f"{total_current_value:,.0f} ì›", 
              delta=f"-{total_acquisition - total_current_value:,.0f} (ê°ê°€ìƒê°)")
with col3:
    st.metric(label="ì˜¬í•´ ì ë¦½í•´ì•¼ í•  ì´ ë¹„ìš©", value=f"{total_yearly_fund:,.0f} ì›",
              help="ëª¨ë“  ì„¤ë¹„ë¥¼ ë™ì¼í•˜ê²Œ ì¬êµ¬ì…í•˜ê¸° ìœ„í•´ ì˜¬í•´ ëª¨ì•„ì•¼ í•  ê¸ˆì•¡ì˜ í•©ê³„ì…ë‹ˆë‹¤.")

st.divider()

# [ì„¹ì…˜ 2] ìƒì„¸ ë¦¬ìŠ¤íŠ¸
st.subheader("ğŸ“‹ ì„¤ë¹„ë³„ ìƒì„¸ í˜„í™©")

# í‘œì‹œí•  ì»¬ëŸ¼ ì„ íƒ ë° í¬ë§·íŒ…ì„ ìœ„í•œ ë³µì‚¬ë³¸ ìƒì„±
display_df = df.copy()

# ë‚ ì§œ í¬ë§· ë³€ê²½ (YYYY-MM-DD)
display_df['êµ¬ì…ì¼ì'] = display_df['êµ¬ì…ì¼ì'].dt.strftime('%Y-%m-%d')

# ìˆ«ì í¬ë§·íŒ… í•¨ìˆ˜
def format_currency(x):
    return f"{x:,.0f} ì›"

# ë³´ì—¬ì¤„ ì»¬ëŸ¼ë§Œ ì„ íƒ ë° ì´ë¦„ ë³€ê²½
final_df = display_df[[
    'ì„¤ë¹„ëª…', 'êµ¬ì…ì¼ì', 'ë‚´ìš©ì—°ìˆ˜', 'ì·¨ë“ì›ê°€', 'í˜„ì¬ì”ì•¡', 'ì˜¬í•´ë§ì”ê°€', 'ì—°ê°„ì ë¦½í•„ìš”ì•¡'
]]

# ë°ì´í„°í”„ë ˆì„ ìŠ¤íƒ€ì¼ë§ (ì²œë‹¨ìœ„ ì½¤ë§ˆ)
st.dataframe(
    final_df.style.format({
        'ì·¨ë“ì›ê°€': format_currency,
        'í˜„ì¬ì”ì•¡': format_currency,
        'ì˜¬í•´ë§ì”ê°€': format_currency,
        'ì—°ê°„ì ë¦½í•„ìš”ì•¡': format_currency,
        'ë‚´ìš©ì—°ìˆ˜': '{} ë…„'
    }),
    use_container_width=True,
    hide_index=True
)

# [íŒ] ì‚¬ìš©ì ê°€ì´ë“œ
st.info("""
**ğŸ’¡ ìš©ì–´ ì„¤ëª…**
- **í˜„ì¬ ì”ì•¡**: êµ¬ì…ì¼ë¡œë¶€í„° ì˜¤ëŠ˜ê¹Œì§€ ê°ê°€ìƒê°ëœ ê¸ˆì•¡ì„ ì œì™¸í•œ í˜„ì¬ ì„¤ë¹„ì˜ ê°€ì¹˜ì…ë‹ˆë‹¤.
- **ì˜¬í•´ ë§ ì”ê°€**: ì˜¬í•´ 12ì›” 31ì¼ì´ ë˜ì—ˆì„ ë•Œ ì˜ˆìƒë˜ëŠ” ì„¤ë¹„ì˜ ê°€ì¹˜ì…ë‹ˆë‹¤.
- **ì—°ê°„ ì ë¦½ í•„ìš”ì•¡**: ë‚´ìš©ì—°ìˆ˜ê°€ ëë‚˜ê¸° ì „, ë™ì¼í•œ ì„¤ë¹„ë¥¼ ì¬êµ¬ë§¤í•˜ê¸° ìœ„í•´ ë§¤ë…„ ì ë¦½í•´ì•¼ í•˜ëŠ” ë¹„ìš©ì…ë‹ˆë‹¤.
""")
